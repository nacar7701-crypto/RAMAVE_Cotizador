@model RAMAVE_Cotizador.Models.Cotizaciones
@{
    ViewData["Title"] = "Nueva Cotización";
    string tipoQuery = Context.Request.Query["tipo"].ToString().ToUpper();
    string tipoInicial = string.IsNullOrEmpty(tipoQuery) ? "FRANCESA" : tipoQuery;
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
        --ramave-red: #c62828;
        --ramave-red-dark: #a81f1f;
        --bg-gray: #f8f9fa;
        --text-dark: #2d3436;
        --border-color: #dee2e6;
    }

    body {
        background-color: var(--bg-gray);
        font-family: 'Inter', sans-serif;
        color: var(--text-dark);
    }

    .page-container {
        padding: 2rem 1rem;
        display: flex;
        justify-content: center;
    }

    .card-form {
        background: white;
        width: 100%;
        max-width: 850px;
        padding: 2.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border-top: 5px solid var(--ramave-red);
    }

    h2 {
        text-align: center;
        color: var(--ramave-red);
        font-weight: 800;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }

    .form-section-title {
        font-size: 0.7rem;
        font-weight: 800;
        color: var(--ramave-red);
        text-transform: uppercase;
        letter-spacing: 1px;
        border-bottom: 2px solid #fceaea;
        padding-bottom: 5px;
        margin: 20px 0 15px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 1rem;
        position: relative;
    }

    label {
        display: block;
        font-size: 0.8rem;
        font-weight: 700;
        margin-bottom: 0.4rem;
        color: #444;
    }

    input,
    select {
        width: 100%;
        padding: 0.7rem 0.9rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
        transition: 0.2s;
        background-color: #fff;
    }

    .input-compact {
        padding: 0.6rem 0.6rem;
        font-size: 0.85rem;
    }

    /* Validaciones */
    .error-text {
        color: var(--ramave-red);
        font-size: 0.7rem;
        font-weight: 600;
        margin-top: 4px;
        display: none;
    }

    .invalid {
        border-color: var(--ramave-red) !important;
        box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.1);
    }

    /* Radio Cards */
    .radio-group-visual {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
    }

    .radio-card {
        position: relative;
        cursor: pointer;
    }

    .radio-card input {
        position: absolute;
        opacity: 0;
    }

    .radio-content {
        border: 2px solid #eee;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        transition: 0.3s;
        background: #fff;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .radio-card input:checked+.radio-content {
        border-color: var(--ramave-red);
        background-color: #fff5f5;
    }

    .radio-content img {
        width: 100%;
        max-width: 60px;
        /* Un poco más grandes para mejor visibilidad */
        height: 60px;
        object-fit: contain;
        margin-bottom: 8px;
    }

    .radio-content span {
        font-size: 0.65rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #666;
    }

    .buttons-container {
        display: grid;
        grid-template-columns: 1fr 1.5fr 1fr;
        gap: 1rem;
        margin-top: 2.5rem;
    }

    .btn {
        padding: 0.9rem;
        border-radius: 10px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        font-size: 0.85rem;
        transition: 0.3s;
    }

    .btn-add {
        background: #2d3436;
        color: white;
    }

    .btn-finish {
        background: var(--ramave-red);
        color: white;
    }

    .btn-back {
        background: #eee;
        color: #666;
    }

    .input-group-custom {
        display: flex;
    }

    .input-group-custom input {
        border-radius: 8px 0 0 8px;
        border-right: none;
    }

    .input-group-text-custom {
        background: #f1f3f5;
        border: 1px solid var(--border-color);
        border-radius: 0 8px 8px 0;
        padding: 0 12px;
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        font-weight: bold;
        color: #777;
    }

    #sectionOnda {
        display: none;
    }

    .presupuesto-info {
        background: #fff5f5;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
        border: 1px solid #f8d7da;
    }

    /* --- MEDIA QUERIES PARA MÓVIL --- */
    @@media (max-width: 600px) {
        .card-form {
            padding: 1.5rem;
            /* Menos padding lateral en móviles */
        }

        h2 {
            font-size: 1.4rem;
        }

        /* En pantallas muy pequeñas, forzamos 2 columnas para que no se vean diminutas */
        .radio-group-visual {
            grid-template-columns: repeat(2, 1fr);
        }

        /* Ajuste de los botones de abajo */
        .buttons-container {
            grid-template-columns: 1fr;
            /* Los botones se apilan uno sobre otro */
            gap: 0.8rem;
        }

        /* Ajuste de la sección 2 (Cliente/Área) */
        #cotizadorForm>div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
            /* Pasamos de 3 columnas a 1 */
        }

        /* Ajuste de la sección 3 (Catálogo/Marca/Tela/Color) */
        #cotizadorForm>div[style*="grid-template-columns: 1fr 1fr 1fr"] {
            grid-template-columns: 1fr 1fr !important;
            /* 2 filas de 2 columnas */
        }
</style>

<div class="page-container">
    <div class="card-form">
        <div id="infoPresupuesto" class="presupuesto-info">
            <span style="color: var(--ramave-red); font-weight: 800; font-size: 0.8rem;">
                <i class="fas fa-file-invoice"></i> PRESUPUESTO ACTIVO: <span id="idPresupuestoTexto">#0</span>
            </span>
        </div>

        <h2>Nueva Cotización</h2>

        <form id="cotizadorForm">
            <div class="form-section-title"><i class="fas fa-cut"></i> 1. Confección</div>
            <div class="radio-group-visual">
                <label class="radio-card">
                    <input type="radio" name="TipoCortina" value="OJILLOS" @(tipoInicial == "OJILLOS" ? "checked" : "")
                        onchange="actualizarInterfaz(this.value)">
                    <div class="radio-content"><img src="/images/persiana-ojillos.jpg"><span>Ojillos</span></div>
                </label>
                <label class="radio-card">
                    <input type="radio" name="TipoCortina" value="FRANCESA" @(tipoInicial == "FRANCESA" ? "checked" :
                                                                                                    "") onchange="actualizarInterfaz(this.value)">
                    <div class="radio-content"><img src="/images/persiana-francesa.jpg"><span>Francesa</span></div>
                </label>
                <label class="radio-card">
                    <input type="radio" name="TipoCortina" value="ONDULADO" @(tipoInicial == "ONDULADO" ? "checked" :
                                                                                                    "") onchange="actualizarInterfaz(this.value)">
                    <div class="radio-content"><img src="/images/persiana-ondulada.jpg"><span>Ondulado</span></div>
                </label>
            </div>

            <div class="form-section-title"><i class="fas fa-user"></i> 2. Proyecto</div>
            <div style="display: grid; grid-template-columns: 0.40fr 0.10fr 0.50fr; align-items: start;">
                <div class="form-group">
                    <label>Cliente</label>
                    <input id="Cliente" class="input-compact" placeholder="Nombre completo" />
                    <span id="err-Cliente" class="error-text">Requerido</span>
                </div>
                <div></div>
                <div class="form-group">
                    <label>Área</label>
                    <input id="Area" class="input-compact" placeholder="Ej. Sala Principal" />
                    <span id="err-Area" class="error-text">Requerido</span>
                </div>
            </div>

            <div class="form-section-title"><i class="fas fa-layer-group"></i> 3. Material</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; margin-bottom: 0.5rem;">
                <div class="form-group">
                    <label>Catálogo</label>
                    <select id="selectCatalogo">
                        <option value="">Seleccione...</option>
                    </select>
                    <span id="err-selectCatalogo" class="error-text">Seleccione uno</span>
                </div>
                <div class="form-group">
                    <label>Marca</label>
                    <select id="selectMarca" disabled>
                        <option value="">Marca...</option>
                    </select>
                    <span id="err-selectMarca" class="error-text">Seleccione uno</span>
                </div>
                <div class="form-group">
                    <label>Tela</label>
                    <select id="selectModelo" disabled>
                        <option value="">Modelo...</option>
                    </select>
                    <span id="err-selectModelo" class="error-text">Seleccione uno</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 0.40fr 0.10fr 0.50fr; align-items: start;">
                <div class="form-group">
                    <label>Tipo de Tela</label>
                    <input id="inputTipoTela" class="input-compact" readonly
                        style="background-color: #f1f3f5; font-weight: bold; color: var(--ramave-red);"
                        placeholder="Tipo..." />
                </div>

                <div></div>

                <div class="form-group">
                    <label>Color</label>
                    <select id="selectColor" disabled>
                        <option value="">Color...</option>
                    </select>
                    <span id="err-selectColor" class="error-text">Seleccione uno</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem;">
                <div>
                    <div class="form-section-title">Instalación</div>
                    <div class="radio-group-visual">
                        <label class="radio-card">
                            <input type="radio" name="radioInstalacion" value="TECHO" checked>
                            <div class="radio-content"><img src="/images/techo.jpeg"><span>Techo</span></div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="radioInstalacion" value="MURO">
                            <div class="radio-content"><img src="/images/muro.jpeg"><span>Muro</span></div>
                        </label>
                    </div>
                </div>
                <div>
                    <div class="form-section-title">Acoplamiento</div>
                    <div class="radio-group-visual">
                        <label class="radio-card">
                            <input type="radio" name="radioAcoplamiento" value="IZQUIERDO" checked>
                            <div class="radio-content"><img src="/images/Izquierda.jpeg"><span>Izq</span></div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="radioAcoplamiento" value="DERECHO">
                            <div class="radio-content"><img src="/images/derecha.jpeg"><span>Der</span></div>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="radioAcoplamiento" value="AMBOS">
                            <div class="radio-content"><img src="/images/Ambos.jpeg"><span>Ambos</span></div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-section-title">4. Medidas y Sistema</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.8rem;">
                <div class="form-group">
                    <label>Ancho (m)</label>
                    <div class="input-group-custom"><input id="ancho" type="number" step="0.01"
                            placeholder="0.00" /><span class="input-group-text-custom">m</span></div>
                    <span id="err-ancho" class="error-text">Medida inválida</span>
                </div>
                <div class="form-group">
                    <label>Alto (m)</label>
                    <div class="input-group-custom"><input id="alto" type="number" step="0.01"
                            placeholder="0.00" /><span class="input-group-text-custom">m</span></div>
                    <span id="err-alto" class="error-text">Medida inválida</span>
                </div>
                <div class="form-group">
                    <label>Sistema</label>
                    <select id="Sistema"></select>
                </div>
                <div class="form-group" id="sectionOnda">
                    <label>% Onda</label>
                    <select id="PorcentajeOnda">
                        <option value="60">60%</option>
                        <option value="80">80%</option>
                        <option value="120">120%</option>
                    </select>
                </div>
            </div>

            <div class="buttons-container">
                <a href="/Administrador/Administrador" class="btn btn-back"
                    onclick="localStorage.removeItem('pId')">CANCELAR</a>
                <button type="button" onclick="accionAgregar()" class="btn btn-add">AGREGAR OTRA CORTINA</button>
                <button type="button" onclick="accionGuardarContinuar()" class="btn btn-finish">GUARDAR Y
                    CONTINUAR</button>
            </div>
        </form>
    </div>
</div>

<script>
    let pId = localStorage.getItem('pId') || null;
    const sistemasMap = {
        "FRANCESA": ["MANUAL", "MOTORIZADO ESTANDAR", "MOTORIZADO WIFI", "MOTORIZADO BATERIA"],
        "ONDULADO": ["MANUAL", "MOTORIZADO WIFI", "MOTORIZADO BATERIA"],
        "OJILLOS": ["MANUAL"]
    };

    function validarFormulario() {
        let esValido = true;
        const ids = ['Cliente', 'Area', 'selectCatalogo', 'selectMarca', 'selectModelo', 'selectColor', 'ancho', 'alto'];

        ids.forEach(id => {
            const el = document.getElementById(id);
            const err = document.getElementById('err-' + id);
            if (!el.value || el.value === "" || (el.type === "number" && el.value <= 0)) {
                el.classList.add('invalid');
                if (err) err.style.display = 'block';
                esValido = false;
            } else {
                el.classList.remove('invalid');
                if (err) err.style.display = 'none';
            }
        });
        return esValido;
    }

    function limpiarCampos() {
        // Limpiamos todo menos el Cliente
        const ids = ['Area', 'ancho', 'alto', 'selectCatalogo', 'selectMarca', 'selectModelo', 'selectColor'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            el.value = "";
            el.classList.remove('invalid');
            const err = document.getElementById('err-' + id);
            if (err) err.style.display = 'none';
        });
        document.getElementById('selectMarca').disabled = true;
        document.getElementById('selectModelo').disabled = true;
        document.getElementById('selectMarca').innerHTML = '<option value="">Marca...</option>';
        document.getElementById('selectModelo').innerHTML = '<option value="">Modelo...</option>';
    }

    async function accionAgregar() {
        if (!validarFormulario()) return;
        if (!pId) await crearPresupuestoBase();
        const exito = await enviarCotizacion();
        if (exito) {
            limpiarCampos();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    async function accionGuardarContinuar() {
        if (!validarFormulario()) return;
        if (!pId) await crearPresupuestoBase();
        const exito = await enviarCotizacion();
        if (exito) {
            localStorage.removeItem('pId');
            // CORRECCIÓN: Agregar /Administrador antes de /Cotizaciones
            window.location.href = '/Administrador/Cotizaciones/PresupuestoFinal/' + pId;
        }
    }

    async function crearPresupuestoBase() {
        const nombre = document.getElementById('Cliente').value;

        // Suponiendo que guardas el UsuarioId en SessionStorage al hacer login
        // Si no, puedes pasarlo desde el ViewBag en el HTML a una variable global
        const userId = @(Context.Session.GetInt32("UsuarioId") ?? 0);

        const requestBody = {
            Nombre: nombre,
            UsuarioId: userId
        };

        const res = await fetch('/api/Cotizador/CrearPresupuesto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody) // Enviamos el objeto completo
        });

        if (res.ok) {
            const data = await res.json();
            pId = data.id;
            localStorage.setItem('pId', pId);
            actualizarUI();
        } else {
            alert("Error al crear el folio del presupuesto");
        }
    }

    function actualizarUI() {
        if (pId) {
            document.getElementById('infoPresupuesto').style.display = 'block';
            document.getElementById('idPresupuestoTexto').innerText = "#" + pId;
            document.getElementById('Cliente').disabled = true;
        }
    }

    async function enviarCotizacion() {
        const data = {
            idTela: parseInt(document.getElementById('selectModelo').value),
            cliente: document.getElementById('Cliente').value,
            ancho: parseFloat(document.getElementById('ancho').value),
            alto: parseFloat(document.getElementById('alto').value),
            tipoCortina: document.querySelector('input[name="TipoCortina"]:checked').value,
            porcentajeOnda: (document.getElementById('sectionOnda').style.display === "block") ? parseInt(document.getElementById('PorcentajeOnda').value) : 0,
            sistema: document.getElementById('Sistema').value,
            area: document.getElementById('Area').value,
            instalacion: document.querySelector('input[name="radioInstalacion"]:checked').value,
            acoplamiento: document.querySelector('input[name="radioAcoplamiento"]:checked').value,
            PresupuestoId: parseInt(pId),
            colorSeleccionado: document.getElementById('selectColor').value,
            tipo: document.getElementById('inputTipoTela').value

        };

        const res = await fetch('/api/Cotizador/Crear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return res.ok;
    }

    document.addEventListener("DOMContentLoaded", () => {
        actualizarUI();
        actualizarInterfaz(document.querySelector('input[name="TipoCortina"]:checked').value);

        const selCat = document.getElementById("selectCatalogo");
        const selMar = document.getElementById("selectMarca");
        const selMod = document.getElementById("selectModelo");
        const selCol = document.getElementById("selectColor");
        const inputTipo = document.getElementById('inputTipoTela'); // Referencia al nuevo campo

        let listaTelasLocal = [];

        // 1. Cargar Catálogos
        fetch('/api/Telas/catalogos-unicos')
            .then(r => r.json())
            .then(d => d.forEach(c => selCat.add(new Option(c, c))));

        // 2. Al cambiar Catálogo -> Cargar Marcas
        selCat.onchange = () => {
            selMar.innerHTML = '<option value="">Marca...</option>';
            selMod.innerHTML = '<option value="">Modelo...</option>';
            selCol.innerHTML = '<option value="">Color...</option>';
            inputTipo.value = ""; // Limpiar tipo
            selMar.disabled = selMod.disabled = selCol.disabled = true;

            if (!selCat.value) return;
            fetch(`/api/Telas/marcas-por-catalogo/${selCat.value}`)
                .then(r => r.json())
                .then(d => {
                    selMar.disabled = false;
                    d.forEach(m => selMar.add(new Option(m.nombre, m.id)));
                });
        };

        // 3. Al cambiar Marca -> Cargar Modelos
        selMar.onchange = () => {
            selMod.innerHTML = '<option value="">Modelo...</option>';
            selCol.innerHTML = '<option value="">Color...</option>';
            inputTipo.value = ""; // Limpiar tipo
            selMod.disabled = selCol.disabled = true;

            if (!selMar.value) return;
            fetch(`/api/Telas/buscar-id-tela?catalogo=${selCat.value}&idMarca=${selMar.value}`)
                .then(r => r.json())
                .then(d => {
                    listaTelasLocal = d;
                    selMod.disabled = false;
                    d.forEach(t => selMod.add(new Option(t.nombre, t.id)));
                });
        };

        // 4. Al cambiar Modelo -> MOSTRAR TIPO Y COLORES
        selMod.onchange = () => {
            selCol.innerHTML = '<option value="">Color...</option>';
            inputTipo.value = ""; // Reset por defecto

            if (!selMod.value) {
                selCol.disabled = true;
                return;
            }

            // Buscamos la tela en la lista local que ya tenemos
            const tela = listaTelasLocal.find(t => t.id == selMod.value);

            if (tela) {
                // MOSTRAR EL TIPO (Asegúrate que tu API devuelva la propiedad .tipo)
                inputTipo.value = tela.tipo || "SIN TIPO";

                // MOSTRAR COLORES
                if (tela.color_nombre) {
                    selCol.disabled = false;
                    const colores = tela.color_nombre.split(',');
                    colores.forEach(c => {
                        const nombreLimpio = c.trim();
                        if (nombreLimpio) {
                            selCol.add(new Option(nombreLimpio, nombreLimpio));
                        }
                    });
                } else {
                    selCol.add(new Option("ÚNICO", "ÚNICO"));
                    selCol.disabled = false;
                }
            }
        };
    });

    function actualizarInterfaz(tipo) {
        document.getElementById('sectionOnda').style.display = tipo === "ONDULADO" ? "block" : "none";
        const selectSist = document.getElementById('Sistema');
        selectSist.innerHTML = "";
        (sistemasMap[tipo] || ["MANUAL"]).forEach(opt => {
            let o = document.createElement("option");
            o.value = opt; o.text = opt;
            selectSist.appendChild(o);
        });
    }
</script>