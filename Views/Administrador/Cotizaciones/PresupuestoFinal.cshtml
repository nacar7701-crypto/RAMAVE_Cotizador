@{
    ViewData["Title"] = "Detalle Maestro del Presupuesto";
}

<style>
    :root {
        --ramave-red: #c62828;
        --ramave-dark: #8e0000;
        --bg-light: #f4f7f6;
        --text-muted: #6c757d;
    }

    body { background-color: var(--bg-light); font-family: 'Inter', sans-serif; font-size: 0.9rem; }

    .header-presupuesto {
        background: white; padding: 2rem; border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.5rem;
        border-top: 5px solid var(--ramave-red);
    }

    /* Panel de Control Maestro */
    .filter-section {
        background: white; padding: 1.5rem; border-radius: 12px;
        margin-bottom: 2rem; border: 1px solid #dee2e6;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }

    .filter-group-title {
        font-size: 0.7rem; font-weight: 800; color: var(--ramave-red);
        text-transform: uppercase; margin-bottom: 8px; border-bottom: 2px solid #f8f9fa;
    }

    /* Cards de Partidas */
    .card-partida {
        background: white; border-radius: 12px; margin-bottom: 2rem;
        overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card-partida-header {
        background: #343a40; color: white; padding: 0.8rem 1.5rem;
        display: flex; justify-content: space-between; align-items: center;
    }

    .table-detalle { width: 100%; font-size: 0.8rem; margin-bottom: 0; table-layout: fixed; }
    .table-detalle th {
        background: #fdfdfd; color: #555; font-weight: 600;
        text-transform: uppercase; font-size: 0.65rem; width: 60%; 
        border-right: 1px solid #eee; padding: 6px 12px;
    }
    .table-detalle td { padding: 6px 12px; }

    .section-title {
        background: #eee; color: #333; padding: 0.4rem 1.2rem;
        font-weight: 800; font-size: 0.7rem; text-transform: uppercase;
    }

    .grid-maestra { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    }

    .text-valor { font-weight: 700; color: #000; word-break: break-all; }
    .d-none-filter { display: none !important; }

    .badge-costo { background: #fff3f3; color: #c62828; padding: 2px 6px; border-radius: 4px; }

    @@media print { .no-print { display: none !important; } .container-fluid { width: 100%; } }
</style>

<div class="container-fluid py-4">
    <div class="header-presupuesto d-flex justify-content-between align-items-start">
        <div>
            <h2 id="folioId" class="mb-2" style="color: var(--ramave-red); font-weight: 800;">#0</h2>
            <p class="mb-1"><strong>Cliente:</strong> <span id="nombreCliente">---</span></p>
            <p class="mb-0"><strong>Fecha:</strong> <span id="fechaCreacion">---</span></p>
        </div>
        <div class="text-end no-print">
            <button class="btn btn-danger mb-3" onclick="window.print()">Imprimir PDF</button>
            <div class="p-3 border rounded">
                <small class="d-block text-muted">TOTAL PÚBLICO GLOBAL</small>
                <h3 id="totalGlobal" class="text-danger fw-bold mb-0">$0.00</h3>
            </div>
        </div>
    </div>

    <div class="filter-section no-print">
        <div class="d-flex justify-content-between mb-3">
            <h6 class="fw-bold"><i class="fas fa-sliders-h"></i> VISIBILIDAD DE CAMPOS (Muestra/Oculta lo que necesites)</h6>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleTodos(true)">Mostrar Todo</button>
                <button class="btn btn-sm btn-outline-danger" onclick="toggleTodos(false)">Ocultar Todo</button>
            </div>
        </div>
        
        <div class="filter-grid">
            <div>
                <div class="filter-group-title">1. Diseño</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-dis-1" checked><label>Datos Base</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-dis-2" checked><label>Configuración</label></div>
            </div>
            <div>
                <div class="filter-group-title">2. Medidas</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-med-1" checked><label>Dimensiones m</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-med-2" checked><label>Dimensiones cm</label></div>
            </div>
            <div>
                <div class="filter-group-title">3. Ingeniería</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-ing-1" checked><label>Confección</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-ing-2" checked><label>Cantidades ML</label></div>
            </div>
            <div>
                <div class="filter-group-title">4. Componentes</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-com-1" checked><label>Herrajes Base</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-com-2" checked><label>Mecanismos</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-com-3" checked><label>Accesorios</label></div>
            </div>
            <div>
                <div class="filter-group-title">5. Costos Mat.</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-cos-1" checked><label>Costo Herrajes</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-cos-2" checked><label>Costo Tela/Motor</label></div>
            </div>
            <div>
                <div class="filter-group-title">6. Venta y Totales</div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-tot-1" checked><label>Público</label></div>
                <div class="form-check small"><input class="form-check-input f-chk" type="checkbox" data-t="f-tot-2" checked><label>Distribuidor</label></div>
            </div>
        </div>
    </div>

    <div id="contenedorPartidas"></div>
</div>

<script>
    async function cargarDatos(id) {
        try {
            const response = await fetch(`/api/Cotizador/PresupuestoCompleto/${id}`);
            const data = await response.json();

            document.getElementById('folioId').innerText = `FOLIO #${id}`;
            document.getElementById('nombreCliente').innerText = data.cliente;
            document.getElementById('fechaCreacion').innerText = new Date(data.fecha).toLocaleDateString();
            document.getElementById('totalGlobal').innerText = fM(data.totalGlobal);

            const contenedor = document.getElementById('contenedorPartidas');
            
            data.detalleCortinas.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'card-partida';
                div.innerHTML = `
                    <div class="card-partida-header">
                        <span class="fw-bold">PARTIDA ${i + 1}: ${c.area}</span>
                        <span>Cliente: ${c.cliente} | ID Partida: ${c.id}</span>
                    </div>
                    <div class="grid-maestra">
                        <div class="border-end">
                            <div class="section-title">1. Datos Generales y Diseño</div>
                            <table class="table table-detalle">
                                <tr class="f-dis-1"><th>Tipo Cortina</th><td class="text-valor">${c.tipoCortina}</td></tr>
                                <tr class="f-dis-1"><th>Sistema</th><td class="text-valor">${c.sistema}</td></tr>
                                <tr class="f-dis-1"><th>Modelo</th><td class="text-valor">${c.modelo}</td></tr>
                                <tr class="f-dis-1"><th>Marca</th><td class="text-valor">${c.marca}</td></tr>
                                <tr class="f-dis-1"><th>Catálogo</th><td class="text-valor">${c.catalogo}</td></tr>
                                <tr class="f-dis-2"><th>Acoplamiento</th><td class="text-valor">${c.acoplamiento}</td></tr>
                                <tr class="f-dis-2"><th>Apertura</th><td class="text-valor">${c.tipoApertura}</td></tr>
                                <tr class="f-dis-2"><th>Instalación</th><td class="text-valor">${c.instalacion}</td></tr>
                            </table>
                            <div class="section-title">2. Medidas y Áreas</div>
                            <table class="table table-detalle">
                                <tr class="f-med-1"><th>Ancho x Alto (m)</th><td class="text-valor">${c.ancho} x ${c.alto}</td></tr>
                                <tr class="f-med-1"><th>Área Total (m2)</th><td class="text-valor">${c.m2} m2</td></tr>
                                <tr class="f-med-2"><th>Ancho x Alto (cm)</th><td class="text-valor">${c.anchoCM} x ${c.alturaCM} cm</td></tr>
                                <tr class="f-med-2"><th>Ancho Rollo</th><td class="text-valor">${c.anchoRollo} m</td></tr>
                            </table>
                        </div>

                        <div class="border-end">
                            <div class="section-title">3. Ingeniería y Confección</div>
                            <table class="table table-detalle">
                                <tr class="f-ing-1"><th>% Onda</th><td class="text-valor">${c.porcentajeOnda}%</td></tr>
                                <tr class="f-ing-1"><th>Num. Lienzos</th><td class="text-valor">${c.numLienzos}</td></tr>
                                <tr class="f-ing-1"><th>Ancho Lienzo Tot.</th><td class="text-valor">${c.totalAnchoLienzo} m</td></tr>
                                <tr class="f-ing-1"><th>Altura Exacta</th><td class="text-valor">${c.alturaExacta} m</td></tr>
                                <tr class="f-ing-2"><th>Total ML</th><td class="text-valor">${c.totalML} m</td></tr>
                                <tr class="f-ing-2"><th>ML a Comprar</th><td class="text-valor text-danger">${c.mlComprar} m</td></tr>
                            </table>
                            <div class="section-title">4. Componentes (Cantidades)</div>
                            <table class="table table-detalle">
                                <tr class="f-com-1"><th>Riel / Soportes</th><td class="text-valor">${c.riel} / ${c.soportes}</td></tr>
                                <tr class="f-com-1"><th>Bastón / Tapón</th><td class="text-valor">${c.baston} / ${c.tapon}</td></tr>
                                <tr class="f-com-1"><th>Union Riel</th><td class="text-valor">${c.unionRiel}</td></tr>
                                <tr class="f-com-2"><th>Broches / Cinta</th><td class="text-valor">${c.cantidadBroches} / ${c.cintaBroches} m</td></tr>
                                <tr class="f-com-2"><th>Correderas Ripple</th><td class="text-valor">${c.correderasRipple}</td></tr>
                                <tr class="f-com-2"><th>Ganchos / Tarlatana</th><td class="text-valor">${c.ganchos} / ${c.tarlatana} m</td></tr>
                                <tr class="f-com-3"><th>Carro Maestro</th><td class="text-valor">${c.carroMaestro}</td></tr>
                                <tr class="f-com-3"><th>Goma Verde / Pesas</th><td class="text-valor">${c.gomaVerde} m / ${c.pesaPlomo}</td></tr>
                                <tr class="f-com-3"><th>Carrito Cortinero</th><td class="text-valor">${c.carritoCortinero}</td></tr>
                            </table>
                        </div>

                        <div style="background: #fcfcfc;">
                            <div class="section-title">5. Análisis de Costos Mat.</div>
                            <table class="table table-detalle">
                                <tr class="f-cos-1"><th>Costo Riel</th><td class="badge-costo">${fM(c.costoRiel)}</td></tr>
                                <tr class="f-cos-1"><th>Costo Soportes</th><td class="badge-costo">${fM(c.costoSoportes)}</td></tr>
                                <tr class="f-cos-1"><th>Costo Correderas</th><td class="badge-costo">${fM(c.costoCorredera)}</td></tr>
                                <tr class="f-cos-2"><th>Precio Tela (ML)</th><td class="badge-costo">${fM(c.precioTelaML)}</td></tr>
                                <tr class="f-cos-2"><th>Costo Total Tela</th><td class="badge-costo">${fM(c.costoTotalTela)}</td></tr>
                                <tr class="f-cos-2"><th>Motor</th><td class="badge-costo">${fM(c.motor)}</td></tr>
                                <tr class="f-cos-2"><th>Costo Tot. Cortinero</th><td class="fw-bold">${fM(c.costoTotalCortinero)}</td></tr>
                            </table>
                            <div class="section-title">6. Precios de Venta</div>
                            <table class="table table-detalle">
                                <tr class="f-tot-1"><th>Cortina (Público)</th><td class="text-valor">${fM(c.precioCortinaPublico)}</td></tr>
                                <tr class="f-tot-1"><th>Cortinero (Público)</th><td class="text-valor">${fM(c.precioCortineroPublico)}</td></tr>
                                <tr class="f-tot-1" style="background: #fff0f0;">
                                    <th class="text-danger">TOTAL PÚBLICO</th>
                                    <td class="text-valor text-danger" style="font-size: 1.1rem;">${fM(c.totalPublico)}</td>
                                </tr>
                                <tr class="f-tot-2"><th>Cortina (Dist.)</th><td class="text-muted">${fM(c.precioCortinaDistribuidor)}</td></tr>
                                <tr class="f-tot-2"><th>Cortinero (Dist.)</th><td class="text-muted">${fM(c.precioCortineroDistribuidor)}</td></tr>
                                <tr class="f-tot-2"><th>TOTAL DISTRIBUIDOR</th><td class="text-valor text-primary">${fM(c.totalDistribuidor)}</td></tr>
                            </table>
                        </div>
                    </div>
                `;
                contenedor.appendChild(div);
            });
            aplicarFiltros();
        } catch (e) { alert("Error cargando datos: " + e); }
    }

    // Lógica de Filtros
    document.addEventListener('change', e => { if(e.target.classList.contains('f-chk')) aplicarFiltros(); });

    function aplicarFiltros() {
        document.querySelectorAll('.f-chk').forEach(chk => {
            const target = chk.getAttribute('data-t');
            document.querySelectorAll('.' + target).forEach(el => {
                chk.checked ? el.classList.remove('d-none-filter') : el.classList.add('d-none-filter');
            });
        });
    }

    function toggleTodos(v) { 
        document.querySelectorAll('.f-chk').forEach(c => c.checked = v); 
        aplicarFiltros(); 
    }

    function fM(v) { return (v || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }

    document.addEventListener("DOMContentLoaded", () => {
        const id = window.location.pathname.split('/').pop();
        cargarDatos(id);
    });
</script>