@{
    ViewData["Title"] = "Presupuesto Maestro Detallado";
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root {
        --ramave-red: #c62828;
        --ramave-dark: #8e0000;
        --bg-body: #f0f2f5;
        --text-main: #1a1a1a;
        --border-color: #e0e0e0;
        --dark-bg: #8e0000;
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        font-size: 0.75rem;
        margin: 0;
    }

    .wrapper { width: 100%; padding: 10px; box-sizing: border-box; }
    .budget-container { background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); padding: 15px; border-top: 5px solid var(--ramave-red); }

    /* PDF HEADER */
    .pdf-header { display: none; border-bottom: 2px solid var(--ramave-red); padding-bottom: 5px; margin-bottom: 10px; }
    .header-logo-row { display: flex; justify-content: space-between; align-items: center; }
    .logo-img { max-width: 120px; height: auto; }
    .company-info h1 { color: var(--ramave-red); margin: 0; font-size: 1.1rem; font-weight: 800; text-transform: uppercase; }

    .client-data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 5px;
        padding: 8px;
        background: #fdfdfd;
        border: 1px solid #eee;
        border-radius: 6px;
    }

    .data-label { font-size: 0.55rem; font-weight: 800; color: #777; text-transform: uppercase; display: block; }
    .data-value { font-size: 0.8rem; font-weight: 700; color: #222; }

    /* UI WEB */
    .filter-toolbar { background: #f8f9fa; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
    .header-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
    .header-top-row h2 { margin: 0; font-size: 1.1rem; font-weight: 700; color: var(--ramave-red); }
    .folio-badge { background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }

    /* TABLA PRINCIPAL */
    .table-main { 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: fixed; 
        margin-bottom: 15px; 
        border: 1px solid var(--border-color); 
    }
    
    .col-base { width: 30%; }
    .col-herrajes { width: 20%; }
    .col-precios { width: 15%; }
    .col-costos { width: 35%; }

    .partida-title { background: var(--dark-bg); color: white; padding: 5px 12px; font-weight: 700; font-size: 0.75rem; }
    .table-main td { vertical-align: top; border: 1px solid var(--border-color); padding: 0; }
    
    .inner-table { width: 100%; border-collapse: collapse; font-size: 0.68rem; }
    .inner-table th { 
        background: #f8f9fa; 
        color: #666; 
        font-weight: 600; 
        text-align: left; 
        padding: 3px 6px; 
        border-bottom: 1px solid var(--border-color); 
        width: 50%; 
        text-transform: uppercase; 
        font-size: 0.58rem; 
    }
    .inner-table td { 
        padding: 3px 6px; 
        font-weight: 700; 
        color: #222; 
        border-bottom: 1px solid var(--border-color); 
        text-align: right; 
    }

    .col-header { background: #f1f1f1; padding: 4px; font-weight: 800; font-size: 0.65rem; text-transform: uppercase; color: #444; text-align: center; border-bottom: 2px solid var(--border-color); }
    .sub-section-header { background: #eee; font-size: 0.6rem; font-weight: 900; padding: 3px; text-align: center; border-bottom: 1px solid #ddd; text-transform: uppercase; }
    .row-subtotal { background-color: #fcfcfc; }
    .row-subtotal td { color: var(--ramave-red) !important; font-size: 0.7rem !important; }
    
    .grand-total-section { background: var(--dark-bg); color: white; padding: 12px; border-radius: 10px; margin-top: 15px; }
    .d-none-filter { display: none !important; }

    /* --- AJUSTES DE IMPRESI칍N --- */
    @@media print {
        @@page { margin: 1cm; size: landscape; }
        body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .no-print { display: none !important; }
        .pdf-header { display: block !important; }
        .wrapper { padding: 0 !important; }
        .budget-container { border: none !important; box-shadow: none !important; padding: 0 !important; }

        /* Evita que una partida se corte a la mitad si hay espacio en la siguiente hoja */
        .part-container { 
            break-inside: avoid; 
            page-break-inside: avoid; 
            margin-bottom: 10px; 
            display: block;
        }

        /* Fuerza a que las celdas y filas no se corten internamente */
        .table-main tr, .inner-table tr { 
            break-inside: avoid !important; 
            page-break-inside: avoid !important; 
        }

        .table-main td { 
            break-inside: avoid !important; 
        }

        .grand-total-section { break-inside: avoid; }
    }
</style>

<div class="wrapper">
    <div class="pdf-header">
        <div class="header-logo-row">
            <img src="/images/logoramave.jpg" alt="RAMAVE" class="logo-img" onerror="this.style.display='none'">
            <div class="company-info">
                <h1>F치brica de Persianas RAMAVE</h1>
            </div>
        </div>
        <div class="client-data-grid">
            <div>
                <span class="data-label">Folio de Cotizaci칩n</span>
                <span class="data-value" id="pdf-folio">#00000</span>
                <div style="margin-top:5px">
                    <span class="data-label">Cliente</span>
                    <span class="data-value" id="pdf-cliente">...</span>
                </div>
            </div>
            <div style="text-align: right;">
                <span class="data-label">Fecha de Generaci칩n</span>
                <span class="data-value" id="pdf-fecha">--/--/----</span>
            </div>
        </div>
    </div>

    <div class="budget-container">
        <div class="header-top-row no-print">
            <div>
                <h2>
                    <span id="lblFolio" class="folio-badge">#00000</span>
                    Cotizaci칩n: <span id="lblCliente" class="text-danger">...</span>
                </h2>
                <small class="text-muted" id="lblFecha"></small>
            </div>
            <div class="d-flex gap-2">
                <a asp-area="Administrador" asp-controller="Cotizaciones" asp-action="Index" class="btn btn-secondary btn-sm">REGRESAR</a>
                <button class="btn btn-danger btn-sm" onclick="window.print()"><span>游늯</span> PDF</button>
            </div>
        </div>

        <div class="filter-toolbar no-print">
            <div class="row g-3">
                <div class="col-md-3 border-end">
                    <p class="data-label mb-2">Columnas</p>
                    <div class="form-check form-switch small"><input class="form-check-input f-chk" type="checkbox" data-t="col-base" id="c1" checked> <label class="form-check-label" for="c1">DATOS BASE</label></div>
                    <div class="form-check form-switch small"><input class="form-check-input f-chk" type="checkbox" data-t="col-herrajes" id="c2" checked> <label class="form-check-label" for="c2">COMPONENTES</label></div>
                    <div class="form-check form-switch small"><input class="form-check-input f-chk" type="checkbox" data-t="col-precios" id="c3" checked> <label class="form-check-label" for="c3">MOTOR</label></div>
                    <div class="form-check form-switch small"><input class="form-check-input f-chk" type="checkbox" data-t="col-costos" id="c4" checked> <label class="form-check-label" for="c4">COSTOS</label></div>
                </div>
                <div class="col-md-3 border-end">
                    <p class="data-label mb-2">1. F치brica</p>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-f-cortinero" id="ff1" checked> <label class="form-check-label">Cortinero</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-f-cortina" id="ff2" checked> <label class="form-check-label">Cortina</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="sec-fabrica" id="ff3" checked> <label class="form-check-label fw-bold">VER F츼BRICA</label></div>
                </div>
                <div class="col-md-3 border-end">
                    <p class="data-label mb-2">2. P칰blico</p>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-p-cortinero" id="fp1" checked> <label class="form-check-label">Cortinero</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-p-cortina" id="fp2" checked> <label class="form-check-label">Cortina</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="sec-publico" id="fp3" checked> <label class="form-check-label fw-bold">VER P칔BLICO</label></div>
                </div>
                <div class="col-md-3">
                    <p class="data-label mb-2">3. Distribuidor</p>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-d-cortinero" id="fd1" checked> <label class="form-check-label">Cortinero</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="f-d-cortina" id="fd2" checked> <label class="form-check-label">Cortina</label></div>
                    <div class="form-check small"><input class="form-check-input f-chk sum-trigger" type="checkbox" data-t="sec-distribuidor" id="fd3" checked> <label class="form-check-label fw-bold">VER DIST.</label></div>
                </div>
            </div>
        </div>

        <div id="listaPartidas"></div>

        <div class="grand-total-section">
            <div class="row text-center">
                <div class="col-md-4 sec-fabrica">
                    <div class="data-label text-white opacity-75">Total F치brica</div>
                    <h3 id="totalFabricaSum" class="mb-0 fw-bold">$0.00</h3>
                </div>
                <div class="col-md-4 sec-publico">
                    <div class="data-label text-white opacity-75">Total P칰blico</div>
                    <h3 id="totalPublicoSum" class="mb-0 fw-bold">$0.00</h3>
                </div>
                <div class="col-md-4 sec-distribuidor">
                    <div class="data-label text-white opacity-75">Total Distribuidor</div>
                    <h3 id="totalDistSum" class="mb-0 fw-bold">$0.00</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];

    async function cargarDatos() {
        const id = window.location.pathname.split('/').pop();
        const res = await fetch(`/api/Cotizador/PresupuestoCompleto/${id}`);
        const data = await res.json();
        rawData = data.detalleCortinas;

        const fechaObj = new Date(data.fecha);
        const fechaFormateada = fechaObj.toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' });
        const folioTexto = "#" + id.toString().padStart(5, '0');

        document.getElementById('lblFolio').innerText = folioTexto;
        document.getElementById('lblCliente').innerText = data.cliente;
        document.getElementById('lblFecha').innerText = "Generado: " + fechaFormateada;
        document.getElementById('pdf-cliente').innerText = data.cliente;
        document.getElementById('pdf-folio').innerText = folioTexto;
        document.getElementById('pdf-fecha').innerText = fechaFormateada;

        const contenedor = document.getElementById('listaPartidas');
        contenedor.innerHTML = "";

        rawData.forEach((c, i) => {
            const partidaDiv = document.createElement('div');
            partidaDiv.className = "part-container"; 
            partidaDiv.innerHTML = `
                <div class="partida-title">COTIZACI칍N ${i + 1}</div>
                <table class="table-main">
                    <tr>
                        <td class="col-base">
                            <div class="col-header">Datos Base</div>
                            <table class="inner-table">
                                <tr><th>TIPO CORTINA</th><td>${c.tipoCortina}</td></tr>
                                <tr><th>% ONDA</th><td>${c.porcentajeOnda}%</td></tr>
                                <tr><th>TIPO</th><td>${c.tipo}</td></tr>
                                <tr><th>MODELO</th><td>${c.modelo || 'N/A'}</td></tr>
                                <tr><th>ANCHO</th><td>${c.ancho} m</td></tr>
                                <tr><th>ALTO</th><td>${c.alto} m</td></tr>
                                <tr><th>M2</th><td>${c.m2} m</td></tr>
                                <tr><th>SISTEMA</th><td>${c.sistema}</td></tr>
                                <tr><th>ACOPLAMIENTO</th><td>${c.acoplamiento}</td></tr>
                                <tr><th>INSTALACI칍N</th><td>${c.instalacion} </td></tr>
                                <tr><th>APERTURA</th><td>${c.tipoApertura}</td></tr>
                            </table>
                        </td>
                        <td class="col-herrajes">
                            <div class="col-header">Componentes</div>
                            <table class="inner-table">
                                <tr><th>ANCHO LIENZO</th><td>${c.totalAnchoLienzo}</td></tr>
                                <tr><th>ML COMPRA</th><td class="text-danger">${c.mlComprar} m</td></tr>
                                <tr><th>ALTURA EXACTA</th><td class="text-danger">${c.totalAltura} m</td></tr>
                            </table>
                        </td>
                        <td class="col-precios">
                            <div class="col-header">Motor</div>
                            <table class="inner-table">
                                <tr><th>MOTOR</th><td>${fM(c.motor)}</td></tr>
                            </table>
                        </td>
                        <td class="col-costos">
                            <div class="col-header">Costos / Precios</div>
                            <div class="sec-fabrica border-bottom mb-1">
                                <div class="sub-section-header">F츼BRICA</div>
                                <table class="inner-table">
                                    <tr class="f-f-cortinero"><th>Cortinero</th><td class="v-val-f" data-v="${c.costoTotalCortinero}">${fM(c.costoTotalCortinero)}</td></tr>
                                    <tr class="f-f-cortina"><th>Cortina</th><td class="v-val-f" data-v="${c.costoTotalCortina}">${fM(c.costoTotalCortina)}</td></tr>
                                    <tr class="row-subtotal"><th>SUBTOTAL</th><td class="part-total-f">$0.00</td></tr>
                                </table>
                            </div>
                            <div class="sec-publico border-bottom mb-1">
                                <div class="sub-section-header" style="background:#fff5f5">P칔BLICO</div>
                                <table class="inner-table">
                                    <tr class="f-p-cortinero"><th>Cortinero</th><td class="v-val-p" data-v="${c.precioCortineroPublico}">${fM(c.precioCortineroPublico)}</td></tr>
                                    <tr class="f-p-cortina"><th>Cortina</th><td class="v-val-p" data-v="${c.precioCortinaPublico}">${fM(c.precioCortinaPublico)}</td></tr>
                                    <tr class="row-subtotal"><th>SUBTOTAL</th><td class="part-total-p">$0.00</td></tr>
                                </table>
                            </div>
                            <div class="sec-distribuidor">
                                <div class="sub-section-header" style="background:#f0f4f8">DISTRIBUIDOR</div>
                                <table class="inner-table">
                                    <tr class="f-d-cortinero"><th>Cortinero</th><td class="v-val-d" data-v="${c.precioCortineroDistribuidor}">${fM(c.precioCortineroDistribuidor)}</td></tr>
                                    <tr class="f-d-cortina"><th>Cortina</th><td class="v-val-d" data-v="${c.precioCortinaDistribuidor}">${fM(c.precioCortinaDistribuidor)}</td></tr>
                                    <tr class="row-subtotal"><th>SUBTOTAL</th><td class="part-total-d">$0.00</td></tr>
                                </table>
                            </div>
                        </td>
                    </tr>
                </table>
            `;
            contenedor.appendChild(partidaDiv);
        });
        aplicarFiltros();
    }

    function aplicarFiltros() {
        document.querySelectorAll('.f-chk').forEach(chk => {
            const target = chk.getAttribute('data-t');
            document.querySelectorAll('.' + target).forEach(el => {
                chk.checked ? el.classList.remove('d-none-filter') : el.classList.add('d-none-filter');
            });
        });

        let granF = 0, granP = 0, granD = 0;
        document.querySelectorAll('.part-container').forEach(container => {
            let partF = 0, partP = 0, partD = 0;
            if (document.getElementById('ff3').checked) {
                const c1 = container.querySelector('.f-f-cortinero .v-val-f');
                const c2 = container.querySelector('.f-f-cortina .v-val-f');
                if (document.getElementById('ff1').checked && c1) partF += parseFloat(c1.dataset.v || 0);
                if (document.getElementById('ff2').checked && c2) partF += parseFloat(c2.dataset.v || 0);
            }
            container.querySelector('.part-total-f').innerText = fM(partF);
            granF += partF;
            if (document.getElementById('fp3').checked) {
                const c1 = container.querySelector('.f-p-cortinero .v-val-p');
                const c2 = container.querySelector('.f-p-cortina .v-val-p');
                if (document.getElementById('fp1').checked && c1) partP += parseFloat(c1.dataset.v || 0);
                if (document.getElementById('fp2').checked && c2) partP += parseFloat(c2.dataset.v || 0);
            }
            container.querySelector('.part-total-p').innerText = fM(partP);
            granP += partP;
            if (document.getElementById('fd3').checked) {
                const c1 = container.querySelector('.f-d-cortinero .v-val-d');
                const c2 = container.querySelector('.f-d-cortina .v-val-d');
                if (document.getElementById('fd1').checked && c1) partD += parseFloat(c1.dataset.v || 0);
                if (document.getElementById('fd2').checked && c2) partD += parseFloat(c2.dataset.v || 0);
            }
            container.querySelector('.part-total-d').innerText = fM(partD);
            granD += partD;
        });
        document.getElementById('totalFabricaSum').innerText = fM(granF);
        document.getElementById('totalPublicoSum').innerText = fM(granP);
        document.getElementById('totalDistSum').innerText = fM(granD);
    }

    document.addEventListener('change', e => { if (e.target.classList.contains('f-chk')) aplicarFiltros(); });
    function fM(v) { return (v || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }
    document.addEventListener("DOMContentLoaded", cargarDatos);
</script>