@model RAMAVE_Cotizador.Models.Cotizaciones

@{
    Layout = "_Layout";
    var precioGeneralPublico = Model.PrecioCortineroPublico + Model.PrecioCortinaPublico;
}

<style>
    :root { --primary-dark: #2c3e50; --accent: #e74c3c; }
    .filter-panel { background: #fdfdfd; border: 1px solid #ddd; display: none; }
    .filter-group-title { font-size: 0.75rem; font-weight: 800; color: #555; text-transform: uppercase; border-bottom: 2px solid #eee; }
    .field-hidden { display: none !important; }
    
    /* Estilos de Tabla Mejorados */
    .table-custom { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
    .table-custom th { background: #f8f9fa; color: #333; font-weight: 700; text-transform: uppercase; font-size: 0.7rem; padding: 10px; border-bottom: 2px solid #dee2e6; }
    .table-custom td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .table-section-title { background: #343a40 !important; color: white !important; font-size: 0.8rem !important; letter-spacing: 1px; }

    @@media print {
        .d-print-none { display: none !important; }
        .card { border: none !important; box-shadow: none !important; }
        .table-custom th { background-color: #f8f9fa !important; -webkit-print-color-adjust: exact; }
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
        <div>
            <a href="@Url.Action("Index")" class="btn btn-outline-dark btn-sm rounded-pill px-3">
                <i class="fas fa-chevron-left me-1"></i> Volver
            </a>
            <button class="btn btn-dark btn-sm rounded-pill px-3 ms-2" onclick="$('#megaPanel').slideToggle()">
                <i class="fas fa-sliders-h me-1"></i> Configurar Columnas
            </button>
        </div>
        <button onclick="window.print()" class="btn btn-danger btn-sm rounded-pill px-4 shadow-sm">
            <i class="fas fa-print me-1"></i> IMPRIMIR PDF
        </button>
    </div>

    <div id="megaPanel" class="filter-panel p-4 mb-4 rounded-4 shadow-sm d-print-none">
        <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
            <h6 class="fw-bold m-0"><i class="fas fa-eye me-2"></i>Control de Visibilidad de Campos</h6>
            <div>
                <button class="btn btn-xs btn-link text-decoration-none" onclick="toggleAll(true)">Marcar todo</button>
                <button class="btn btn-xs btn-link text-decoration-none text-muted" onclick="toggleAll(false)">Desmarcar todo</button>
            </div>
        </div>
        <div class="row">
            @{
                var grupos = new Dictionary<string, string[]> {
                    { "group-gen", new[] { "Cliente", "Area", "Catalogo", "Marca", "Modelo", "TipoCortina", "Sistema", "Instalacion", "TipoApertura", "Acoplamiento" } },
                    { "group-med", new[] { "Ancho", "Alto", "AnchoCM", "AlturaCM", "AnchoRollo", "NumLienzos", "TotalAnchoLienzo", "TotalAltura", "AlturaExacta", "TotalML", "MLComprar", "M2", "PorcentajeOnda" } },
                    { "group-cant", new[] { "Riel", "Tapon", "Baston", "Soportes", "UnionRiel", "Tarlatana", "CarroEmbaladoFrances", "Ganchos", "TopeCarritoSujecion", "Engrane", "TapasEngrane", "Hebilla", "CorrederaGoma", "GomaVerde", "PesaPlomo", "CarritoCortinero", "GanchoFinal", "CintaPlomo", "CarroMaestro", "CorrederasRipple", "CantidadBroches", "CintaBroches" } }
                };
            }
            @foreach (var grupo in grupos) {
                <div class="col-md-3 border-end">
                    <p class="filter-group-title">@grupo.Key.Replace("group-", "")</p>
                    <div class="@grupo.Key" style="max-height: 200px; overflow-y: auto;">
                        @foreach (var f in grupo.Value) {
                            <div class="form-check">
                                <input class="form-check-input f-check" type="checkbox" value="f-@f.ToLower()" id="chk@f" checked>
                                <label class="form-check-label small" for="chk@f">@f</label>
                            </div>
                        }
                    </div>
                </div>
            }
            <div class="col-md-3">
                <p class="filter-group-title">Costos y Totales</p>
                <div class="form-check"><input class="form-check-input f-check" type="checkbox" value="f-costos-unit" id="chkCU" checked><label class="form-check-label small">Costos Unitarios</label></div>
                <div class="form-check"><input class="form-check-input f-check" type="checkbox" value="f-total-fab" id="chkTF" checked><label class="form-check-label small">Sección Fábrica</label></div>
                <div class="form-check"><input class="form-check-input f-check" type="checkbox" value="f-total-dis" id="chkTD" checked><label class="form-check-label small">Sección Distribuidor</label></div>
                <div class="form-check"><input class="form-check-input f-check" type="checkbox" value="f-total-pub" id="chkTP" checked><label class="form-check-label small">Sección Público</label></div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 rounded-3 overflow-hidden">
        <div class="bg-dark p-4 text-white">
            <div class="row align-items-center">
                <div class="col-8">
                    <h4 class="mb-0 fw-bold">COTIZACIÓN TÉCNICA DETALLADA</h4>
                    <span class="badge bg-danger">ID: #@Model.Id</span>
                </div>
                <div class="col-4 text-end">
                    <h5 class="mb-0">RAMAVE</h5>
                    <small class="text-white-50">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</small>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <table class="table-custom">
                <thead>
                    <tr><th colspan="4" class="table-section-title">1. Información del Proyecto</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="f-cliente fw-bold">Cliente:</td><td class="f-cliente">@Model.Cliente</td>
                        <td class="f-area fw-bold">Área:</td><td class="f-area">@Model.Area</td>
                    </tr>
                    <tr>
                        <td class="f-catalogo fw-bold">Catálogo:</td><td class="f-catalogo">@Model.Catalogo</td>
                        <td class="f-marca fw-bold">Marca:</td><td class="f-marca">@Model.Marca</td>
                    </tr>
                    <tr>
                        <td class="f-modelo fw-bold">Modelo:</td><td class="f-modelo">@Model.Modelo</td>
                        <td class="f-tipocortina fw-bold">Tipo Cortina:</td><td class="f-tipocortina">@Model.TipoCortina</td>
                    </tr>
                    <tr>
                        <td class="f-sistema fw-bold text-primary">Sistema:</td><td class="f-sistema text-primary fw-bold">@Model.Sistema</td>
                        <td class="f-instalacion fw-bold">Instalación:</td><td class="f-instalacion">@Model.Instalacion</td>
                    </tr>
                </tbody>
            </table>

            <table class="table-custom">
                <thead>
                    <tr><th colspan="6" class="table-section-title text-warning">2. Dimensiones y Manufactura</th></tr>
                    <tr class="bg-light">
                        <th class="f-ancho">Ancho (m)</th><th class="f-alto">Alto (m)</th><th class="f-m2">Total M2</th>
                        <th class="f-totalml">Total ML</th><th class="f-mlcomprar">ML Comprar</th><th class="f-porcentajeonda">Onda %</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="f-ancho">@Model.Ancho.ToString("N2") m</td>
                        <td class="f-alto">@Model.Alto.ToString("N2") m</td>
                        <td class="f-m2 fw-bold">@Model.M2.ToString("N2")</td>
                        <td class="f-totalml">@Model.TotalML.ToString("N2")</td>
                        <td class="f-mlcomprar text-danger fw-bold">@Model.MLComprar.ToString("N2")</td>
                        <td class="f-porcentajeonda">@Model.PorcentajeOnda%</td>
                    </tr>
                </tbody>
            </table>

            <table class="table-custom">
                <thead>
                    <tr><th colspan="4" class="table-section-title text-info">3. Inventario de Componentes y Cantidades</th></tr>
                </thead>
                <tbody class="small">
                    <tr>
                        <td class="f-riel"><b>Riel:</b> @Model.Riel</td>
                        <td class="f-tapon"><b>Tapón:</b> @Model.Tapon</td>
                        <td class="f-baston"><b>Bastón:</b> @Model.Baston</td>
                        <td class="f-soportes"><b>Soportes:</b> @Model.Soportes</td>
                    </tr>
                    <tr>
                        <td class="f-unionriel"><b>Unión Riel:</b> @Model.UnionRiel</td>
                        <td class="f-tarlatana"><b>Tarlatana:</b> @Model.Tarlatana</td>
                        <td class="f-ganchos"><b>Ganchos:</b> @Model.Ganchos</td>
                        <td class="f-carromaestro"><b>Carro Maestro:</b> @Model.CarroMaestro</td>
                    </tr>
                    <tr>
                        <td class="f-correderasripple"><b>Corr. Ripple:</b> @Model.CorrederasRipple</td>
                        <td class="f-cintabroches"><b>Cinta Broches:</b> @Model.CintaBroches</td>
                        <td class="f-pesaplomo"><b>Pesa Plomo:</b> @Model.PesaPlomo</td>
                        <td class="f-cantidadbroches"><b>Cant. Broches:</b> @Model.CantidadBroches</td>
                    </tr>
                    <tr>
                        <td class="f-carroembaladofrances"><b>Carro Francés:</b> @Model.CarroEmbaladoFrances</td>
                        <td class="f-topecarritosujecion"><b>Tope Sujeción:</b> @Model.TopeCarritoSujecion</td>
                        <td class="f-engrane"><b>Engrane:</b> @Model.Engrane</td>
                        <td class="f-tapasengrane"><b>Tapas Engrane:</b> @Model.TapasEngrane</td>
                    </tr>
                </tbody>
            </table>

            <div class="row g-0">
                <div class="col-md-6 f-total-fab border-end">
                    <table class="table-custom">
                        <thead><tr><th class="bg-secondary text-white">Resumen Fábrica</th></tr></thead>
                        <tbody>
                            <tr><td class="d-flex justify-content-between"><span>Costo Cortinero:</span> <b>@Model.CostoTotalCortinero.ToString("C")</b></td></tr>
                            <tr><td class="d-flex justify-content-between"><span>Costo Cortina:</span> <b>@Model.CostoTotalCortina.ToString("C")</b></td></tr>
                            <tr class="bg-light"><td class="d-flex justify-content-between"><span>TOTAL COSTO:</span> <b class="text-dark">@Model.CostoTotalGeneral.ToString("C")</b></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6 f-total-pub">
                    <table class="table-custom">
                        <thead><tr><th class="bg-danger text-white">Resumen Público</th></tr></thead>
                        <tbody>
                            <tr><td class="d-flex justify-content-between"><span>Precio Cortinero:</span> <b>@Model.PrecioCortineroPublico.ToString("C")</b></td></tr>
                            <tr><td class="d-flex justify-content-between"><span>Precio Cortina:</span> <b>@Model.PrecioCortinaPublico.ToString("C")</b></td></tr>
                            <tr class="bg-danger text-white"><td class="d-flex justify-content-between"><span>TOTAL PÚBLICO:</span> <b class="fs-5">@Model.TotalPublico.ToString("C")</b></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('.f-check').on('change', function() {
            const target = $(this).val();
            if ($(this).is(':checked')) {
                $('.' + target).removeClass('field-hidden');
            } else {
                $('.' + target).addClass('field-hidden');
            }
        });
    });

    function toggleAll(status) {
        $('.f-check').prop('checked', status).trigger('change');
    }
</script>