@{
    ViewData["Title"] = "Gesti√≥n de Marcas y Modelos";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
    :root {
        --ramave-red: #c62828;
        --ramave-dark: #8e0000;
        --ramave-soft-red: #fff5f5;
        --bg-light: #f0f2f5;
        --text-main: #2d3436;
        --text-muted: #636e72;
        --border-color: #dfe6e9;
    }

    body { 
        background-color: var(--bg-light); 
        font-family: 'Inter', sans-serif; 
        color: var(--text-main);
        margin: 0;
    }

    .wrapper { 
        padding: 15px; 
        max-width: 1200px; 
        margin: 0 auto; 
    }

    /* Grid principal responsivo */
    .admin-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
        gap: 20px;
    }

    .card-admin {
        background: white; 
        border-radius: 16px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
        height: 75vh; 
        display: flex; 
        flex-direction: column;
        overflow: hidden;
    }

    /* Ajustes para m√≥viles */
    @@media (max-width: 768px) {
        .wrapper { padding: 10px; }
        .card-admin { height: auto; max-height: 600px; }
        .admin-grid { grid-template-columns: 1fr; }
        .btn-save { padding: 0 15px; font-size: 0.7rem; }
    }

    /* Cabeceras */
    .card-header { 
        padding: 20px; 
        border-bottom: 2px solid var(--ramave-soft-red); 
    }
    
    .card-header h2 { 
        margin: 0; 
        font-size: 1rem; 
        color: var(--ramave-red); 
        font-weight: 800; 
        text-transform: uppercase; 
    }

    /* Caja de Registro */
    .registration-box { 
        padding: 15px 20px; 
        background: var(--ramave-soft-red); 
        border-bottom: 1px solid var(--border-color); 
    }
    
    .input-group { display: flex; gap: 8px; margin-top: 8px; }
    
    .form-control {
        flex: 1; 
        padding: 10px 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        font-size: 0.9rem;
        outline: none; 
    }
    
    .btn-save {
        background: var(--ramave-red); 
        color: white; 
        border: none; 
        padding: 0 20px;
        border-radius: 8px; 
        font-weight: 700; 
        cursor: pointer;
        text-transform: uppercase;
    }

    /* Contenedor de Listas */
    .list-container { flex: 1; overflow-y: auto; padding: 15px; }
    
    .search-mini { 
        width: 100%; 
        padding: 10px 15px; 
        margin-bottom: 15px; 
        border: 1px solid var(--border-color); 
        border-radius: 25px; 
        font-size: 0.85rem; 
        background: #f8f9fa;
        box-sizing: border-box;
    }

    /* Filas de la lista */
    .item-row {
        padding: 10px; 
        border-bottom: 1px solid #f1f1f1; 
        display: flex; 
        justify-content: space-between;
        align-items: center; 
        cursor: pointer; 
        transition: 0.2s; 
        border-radius: 8px; 
        margin-bottom: 4px;
    }
    
    .item-row:hover { background: var(--ramave-soft-red); }
    
    .item-row.selected { 
        background: #fff1f1; 
        border-left: 4px solid var(--ramave-red);
        font-weight: 700;
    }

    /* Acciones */
    .actions-group { display: flex; gap: 5px; }
    
    .btn-action {
        border: none; 
        background: white; 
        width: 30px; 
        height: 30px; 
        border-radius: 6px;
        cursor: pointer; 
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .edit-input {
        padding: 5px 10px; 
        border: 2px solid var(--ramave-red); 
        border-radius: 6px; 
        width: 70%;
    }
</style>

<div class="wrapper">
    <div style="margin-bottom: 20px;">
        <button onclick="location.href='@Url.Action("Telas", "Administrador")'" 
                style="background:white; border:1px solid var(--ramave-red); color:var(--ramave-red); padding: 8px 15px; border-radius: 8px; cursor:pointer; font-weight:700; font-size: 0.75rem;">
            ‚Üê INVENTARIO
        </button>
    </div>

    <div class="admin-grid">
        <div class="card-admin">
            <div class="card-header"><h2>1. Marcas</h2></div>
            <div class="registration-box">
                <div class="input-group">
                    <input type="text" id="txtNuevaMarca" class="form-control" placeholder="Nueva marca...">
                    <button class="btn-save" onclick="guardarMarca()">OK</button>
                </div>
            </div>
            <div class="list-container">
                <input type="text" class="search-mini" placeholder="üîç Filtrar marcas..." onkeyup="filtrarLista('listaMarcas', this.value)">
                <div id="listaMarcas"></div>
            </div>
        </div>

        <div class="card-admin">
            <div class="card-header">
                <h2>2. Modelos</h2>
                <div id="marcaSeleccionadaNombre" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">Selecciona una marca arriba</div>
            </div>
            <div class="registration-box" id="boxModelo" style="display: none;">
                <div class="input-group">
                    <input type="text" id="txtNuevoModelo" class="form-control" placeholder="Nuevo modelo...">
                    <button class="btn-save" onclick="guardarModelo()">OK</button>
                </div>
            </div>
            <div class="list-container">
                <input type="text" id="searchModelo" class="search-mini" placeholder="üîç Filtrar modelos..." onkeyup="filtrarLista('listaModelos', this.value)" style="display:none;">
                <div id="listaModelos">
                    <div style="text-align: center; color: #ced4da; margin-top: 50px;">
                         Selecciona una marca
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let marcaSeleccionadaId = null;

    document.addEventListener("DOMContentLoaded", cargarMarcas);

    async function cargarMarcas() {
        const res = await fetch('/api/Telas/marcas');
        const marcas = await res.json();
        const contenedor = document.getElementById('listaMarcas');
        
        contenedor.innerHTML = marcas.map(m => `
            <div class="item-row" id="marca-${m.id}" onclick="seleccionarMarca(${m.id}, '${m.nombre}')">
                <div id="content-marca-${m.id}" style="flex:1">
                    <span class="txt-name">${m.nombre}</span>
                </div>
                <div class="actions-group" id="actions-marca-${m.id}">
                    <button class="btn-action" onclick="habilitarEdicionFila(event, 'marca', ${m.id}, '${m.nombre}')">‚úèÔ∏è</button>
                    <button class="btn-action" onclick="eliminarMarca(event, ${m.id})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    async function guardarMarca() {
        const nombre = document.getElementById('txtNuevaMarca').value;
        if(!nombre) return;
        const res = await fetch('/api/Telas/marcas', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre })
        });
        if(res.ok) { document.getElementById('txtNuevaMarca').value = ''; cargarMarcas(); }
    }

    async function seleccionarMarca(id, nombre) {
        marcaSeleccionadaId = id;
        document.querySelectorAll('.item-row').forEach(el => el.classList.remove('selected'));
        const row = document.getElementById(`marca-${id}`);
        if(row) row.classList.add('selected');

        document.getElementById('marcaSeleccionadaNombre').innerHTML = `Marca: <b style="color:var(--ramave-red)">${nombre}</b>`;
        document.getElementById('boxModelo').style.display = 'block';
        document.getElementById('searchModelo').style.display = 'block';
        cargarModelos(id);
    }

    async function cargarModelos(idMarca) {
        const res = await fetch(`/api/Telas/modelos/${idMarca}`);
        const modelos = await res.json();
        const contenedor = document.getElementById('listaModelos');

        if(modelos.length === 0) {
            contenedor.innerHTML = '<div style="text-align: center; color: #ced4da; margin-top: 30px;">Sin modelos.</div>';
            return;
        }

        contenedor.innerHTML = modelos.map(m => `
            <div class="item-row" id="modelo-row-${m.id}">
                <div id="content-modelo-${m.id}" style="flex:1">
                    <span>${m.nombre}</span>
                </div>
                <div class="actions-group" id="actions-modelo-${m.id}">
                    <button class="btn-action" onclick="habilitarEdicionFila(event, 'modelo', ${m.id}, '${m.nombre}')">‚úèÔ∏è</button>
                    <button class="btn-action" onclick="eliminarModelo(event, ${m.id})">üóëÔ∏è</button>
                </div>
            </div>
        `).join('');
    }

    async function guardarModelo() {
        const nombre = document.getElementById('txtNuevoModelo').value;
        if(!nombre || !marcaSeleccionadaId) return;
        const res = await fetch('/api/Telas/modelos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nombre, id_marca: marcaSeleccionadaId })
        });
        if(res.ok) { document.getElementById('txtNuevoModelo').value = ''; cargarModelos(marcaSeleccionadaId); }
    }

    function habilitarEdicionFila(event, tipo, id, nombreActual) {
        event.stopPropagation();
        const divContent = document.getElementById(`content-${tipo}-${id}`);
        const divActions = document.getElementById(`actions-${tipo}-${id}`);

        divContent.innerHTML = `<input type="text" id="input-edit-${tipo}-${id}" class="edit-input" value="${nombreActual}" onclick="event.stopPropagation()">`;
        divActions.innerHTML = `
            <button class="btn-action" onclick="confirmarEdicion(event, '${tipo}', ${id})" style="color:green">‚úîÔ∏è</button>
            <button class="btn-action" onclick="event.stopPropagation(); ${tipo === 'marca' ? 'cargarMarcas()' : 'cargarModelos(marcaSeleccionadaId)'}">‚ùå</button>
        `;
    }

    async function confirmarEdicion(event, tipo, id) {
        event.stopPropagation();
        const nuevoNombre = document.getElementById(`input-edit-${tipo}-${id}`).value;
        const body = { id: id, nombre: nuevoNombre };
        if(tipo === 'modelo') body.id_marca = marcaSeleccionadaId;

        const res = await fetch(`/api/Telas/${tipo === 'marca' ? 'marcas' : 'modelos'}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        if(res.ok) tipo === 'marca' ? cargarMarcas() : cargarModelos(marcaSeleccionadaId);
    }

    async function eliminarMarca(event, id) {
        event.stopPropagation();
        if(!confirm("¬øEliminar marca?")) return;
        const res = await fetch(`/api/Telas/marcas/${id}`, { method: 'DELETE' });
        if(res.ok) { cargarMarcas(); if(marcaSeleccionadaId === id) resetModelosView(); }
    }

    async function eliminarModelo(event, id) {
        event.stopPropagation();
        if(!confirm("¬øEliminar modelo?")) return;
        const res = await fetch(`/api/Telas/modelos/${id}`, { method: 'DELETE' });
        if(res.ok) cargarModelos(marcaSeleccionadaId);
    }

    function resetModelosView() {
        marcaSeleccionadaId = null;
        document.getElementById('boxModelo').style.display = 'none';
        document.getElementById('searchModelo').style.display = 'none';
        document.getElementById('listaModelos').innerHTML = 'Selecciona una marca';
    }

    function filtrarLista(idContenedor, texto) {
        const val = texto.toLowerCase();
        const items = document.getElementById(idContenedor).getElementsByClassName('item-row');
        for (let item of items) {
            item.style.display = item.textContent.toLowerCase().includes(val) ? "flex" : "none";
        }
    }
</script>