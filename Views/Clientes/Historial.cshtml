@model IEnumerable<RAMAVE_Cotizador.Models.Presupuesto>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Mi Historial de Cotizaciones";
    var rol = HttpContextAccessor.HttpContext.Session.GetString("UsuarioRol")?.Trim();
    string etiquetaPrecio = (rol == "Distribuidor") ? "Total Distribuidor" : "Total P√∫blico";
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
        --ramave-red: #c62828;
        --ramave-dark: #8e0000;
        --bg-body: #f0f2f5;
        --text-main: #1a1a1a;
        --border-color: #e0e0e0;
        --group-bg: #fdf2f2;
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        font-size: 0.85rem;
    }

    .wrapper { width: 100%; padding: 15px; box-sizing: border-box; }

    .header-panel {
        background: white; padding: 1.5rem; border-radius: 12px;
        display: flex; flex-direction: column; gap: 12px;
        margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .header-top-row { display: flex; justify-content: space-between; align-items: center; }
    .header-panel h2 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--ramave-red); }

    .search-input {
        width: 100%; padding: 12px; border-radius: 8px;
        border: 1px solid var(--border-color); background: #f8f9fa;
    }

    /* AJUSTE DE COLUMNAS */
    .table-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
    
    table { 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: fixed; /* Fuerza el respeto de los anchos */
    }

    th { 
        background: #f8f9fa; 
        padding: 12px; 
        font-size: 0.7rem; 
        text-transform: uppercase; 
        color: #666; 
        border-bottom: 2px solid var(--border-color);
        text-align: left;
    }

    /* Definici√≥n de anchos */
    .col-info { width: 35%; }
    .col-detalles { width: 25%; }
    .col-medidas { width: 20%; }
    .col-precio { width: 20%; text-align: right; }

    .group-header { background-color: var(--group-bg) !important; border-left: 5px solid var(--ramave-red); font-weight: 800; color: var(--ramave-red); }
    .fila-cotizacion td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }

    .folio-badge {
        background: var(--ramave-red); color: white; padding: 4px 12px;
        border-radius: 15px; font-size: 0.75rem; margin-right: 10px;
    }

    .price-total { font-weight: 700; color: var(--ramave-red); font-size: 1rem; display: block; text-align: right; }

    .btn-main {
        padding: 10px 16px; border-radius: 8px; font-weight: 600;
        text-decoration: none; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px;
    }
    .btn-gray { background: #e0e0e0; color: #333; }
    .date-text { font-size: 0.75rem; color: #888; font-weight: 400; margin-left: 10px; }
    
    .role-indicator {
        font-size: 0.7rem; background: #eee; padding: 2px 8px; border-radius: 4px; color: #666; font-weight: normal;
    }
</style>

<div class="wrapper">
    <div class="header-panel">
        <div class="header-top-row">
            <h2>
                <i class="fas fa-history"></i> Mi Historial 
                <span class="role-indicator">Sesi√≥n: @rol</span>
            </h2>
            <a href="@Url.Action("Index", "Clientes")" class="btn-main btn-gray">
                <i class="fas fa-chevron-left"></i> Volver al Men√∫
            </a>
        </div>
        <input type="text" id="txtBuscar" class="search-input" 
               placeholder="üîç Buscar por folio, √°rea, modelo o cliente..." onkeyup="filtrarTabla()">
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th class="col-info">Informaci√≥n T√©cnica</th>
                    <th class="col-detalles">Detalles Producto</th>
                    <th class="col-medidas">Medidas</th>
                    <th class="col-precio">@etiquetaPrecio</th>
                </tr>
            </thead>
            <tbody id="listaCotizaciones">
                @if (Model == null || !Model.Any())
                {
                    <tr><td colspan="4" style="text-align:center; padding: 40px; color: #888;">No tienes cotizaciones registradas.</td></tr>
                }
                else
                {
                    @foreach (var presupuesto in Model)
                    {
                        <tr class="group-header" data-searchable="@presupuesto.NombreCliente @presupuesto.Id">
                            <td colspan="4">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span class="folio-badge">FOLIO #@presupuesto.Id</span>
                                        <span style="color: #333;">Proyecto: <strong>@presupuesto.NombreCliente</strong></span>
                                        <span class="date-text">@presupuesto.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                    <div style="margin-right: 15px;">
                                        <a href="@Url.Action("PresupuestoFinal", "Clientes", new { id = presupuesto.Id })" style="color: var(--ramave-red); text-decoration: none; font-size: 0.8rem; font-weight: 700;">
                                            <i class="fas fa-file-pdf"></i> VER PDF COMPLETO
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        foreach (var item in presupuesto.Cotizaciones)
                        {
                            decimal precioAMostrar = (rol == "Distribuidor") 
                                ? (item.PrecioCortinaDistribuidor + item.PrecioCortineroDistribuidor) 
                                : item.TotalPublico;

                            <tr class="fila-cotizacion" data-parent-folio="@presupuesto.Id">
                                <td class="col-info">
                                    <div><strong>@item.Area</strong></div>
                                    <div style="font-size: 0.75rem; color: #666;">@item.Sistema | @item.TipoCortina</div>
                                </td>
                                <td class="col-detalles">
                                    <div>@item.Marca - @item.Modelo</div>
                                    <div style="font-size: 0.75rem; color: #666;">Color: @(item.ColorSeleccionado ?? "N/A")</div>
                                </td>
                                <td class="col-medidas">
                                    <strong>@item.Ancho.ToString("N2") x @item.Alto.ToString("N2") m</strong>
                                </td>
                                <td class="col-precio">
                                    <span class="price-total">@precioAMostrar.ToString("C")</span>
                                </td>
                            </tr>
                        }
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function filtrarTabla() {
        const query = document.getElementById('txtBuscar').value.toLowerCase().trim();
        const cabeceras = document.querySelectorAll('.group-header');
        
        cabeceras.forEach(header => {
            const infoCabecera = header.getAttribute('data-searchable').toLowerCase();
            let tieneHijosVisibles = false;
            let siguiente = header.nextElementSibling;
            
            while (siguiente && siguiente.classList.contains('fila-cotizacion')) {
                const contenidoFila = siguiente.innerText.toLowerCase();
                if (contenidoFila.includes(query) || infoCabecera.includes(query)) {
                    siguiente.style.display = "";
                    tieneHijosVisibles = true;
                } else {
                    siguiente.style.display = "none";
                }
                siguiente = siguiente.nextElementSibling;
            }
            header.style.display = (infoCabecera.includes(query) || tieneHijosVisibles) ? "" : "none";
        });
    }
</script>