@model IEnumerable<RAMAVE_Cotizador.Models.Presupuesto>
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["Title"] = "Mi Historial de Cotizaciones";
    var rol = HttpContextAccessor.HttpContext.Session.GetString("UsuarioRol")?.Trim();
    string etiquetaPrecio = (rol == "Distribuidor") ? "TotalDistribuidor" : "TotalPublico";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
        --ramave-red: #c62828;
        --ramave-dark: #8e0000;
        --bg-body: #f0f2f5;
        --text-main: #1a1a1a;
        --border-color: #e0e0e0;
        --group-bg: #fdf2f2;
    }

    body { background-color: var(--bg-body); font-family: 'Inter', sans-serif; color: var(--text-main); font-size: 0.85rem; }
    .wrapper { width: 100%; padding: 15px; box-sizing: border-box; }

    .header-panel {
        background: white; padding: 1.5rem; border-radius: 12px;
        display: flex; flex-direction: column; gap: 12px;
        margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .header-top-row { display: flex; justify-content: space-between; align-items: center; }
    .header-panel h2 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--ramave-red); }

    .search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: #f8f9fa; }

    /* IMPORTANTE: Permitir que el men√∫ sobresalga de la tarjeta */
    .table-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: visible; }
    
    table { width: 100%; border-collapse: collapse; table-layout: fixed; overflow: visible; }

    th { 
        background: #f8f9fa; padding: 12px; font-size: 0.7rem; 
        text-transform: uppercase; color: #666; 
        border-bottom: 2px solid var(--border-color); text-align: left;
    }

    .col-info { width: 30%; }
    .col-detalles { width: 25%; }
    .col-medidas { width: 20%; }
    .col-precio { width: 15%; text-align: right; }
    .col-acciones { width: 10%; text-align: center; overflow: visible; position: relative; }

    .group-header { background-color: var(--group-bg) !important; border-left: 5px solid var(--ramave-red); font-weight: 800; color: var(--ramave-red); }
    .fila-cotizacion td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }

    .folio-link {
        background: var(--ramave-red); color: white; padding: 6px 14px;
        border-radius: 15px; font-size: 0.75rem; text-decoration: none;
        font-weight: 700; transition: background 0.2s; display: inline-flex; align-items: center; gap: 6px;
    }
    .folio-link:hover { background: var(--ramave-dark); }

    /* MENU TOGGLE MEJORADO */
    .action-menu { position: relative; display: inline-block; }
    
    .btn-toggle {
        background: #f8f9fa; border: 1px solid #e0e0e0; cursor: pointer; color: #333;
        padding: 5px 10px; border-radius: 6px; transition: all 0.2s; font-size: 1.1rem;
    }
    .btn-toggle:hover { background: #eee; color: var(--ramave-red); }

    .dropdown-content {
        display: none; position: absolute; right: 0; top: 35px;
        background: white; min-width: 130px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 999; border: 1px solid #ddd;
    }
    .dropdown-content.show { display: block; animation: fadeIn 0.2s ease; }

    .dropdown-item {
        display: flex; align-items: center; gap: 8px; padding: 10px 12px;
        text-decoration: none; color: #333; font-size: 0.85rem; font-weight: 500;
    }
    .dropdown-item:hover { background: #fff1f1; color: var(--ramave-red); }

    .price-total { font-weight: 700; color: var(--ramave-red); font-size: 1rem; display: block; text-align: right; }
    .btn-gray { background: #e0e0e0; color: #333; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-size: 0.8rem; }
</style>

<div class="wrapper">
    <div class="header-panel">
        <div class="header-top-row">
            <h2><i class="fas fa-history"></i> Mi Historial</h2>
            <a href="@Url.Action("Index", "Clientes")" class="btn-gray">
                <i class="fas fa-chevron-left"></i> Volver
            </a>
        </div>
        <input type="text" id="txtBuscar" class="search-input" placeholder="üîç Buscar por folio, cliente, etc..." onkeyup="filtrarTabla()">
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th class="col-info">Informaci√≥n</th>
                    <th class="col-detalles">Producto</th>
                    <th class="col-medidas">Medidas</th>
                    <th class="col-precio">@etiquetaPrecio</th>
                    <th class="col-acciones">Acciones</th>
                </tr>
            </thead>
            <tbody id="listaCotizaciones">
                @foreach (var presupuesto in Model)
                {
                    <tr class="group-header" data-searchable="@presupuesto.NombreCliente @presupuesto.Id">
                        <td colspan="5">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <a href="@Url.Action("PresupuestoFinal", "Clientes", new { id = presupuesto.Id })" class="folio-link">
                                        <i class="fas fa-file-pdf"></i> FOLIO #@presupuesto.Id
                                    </a>
                                    <span style="margin-left:10px; color:#333;">Proyecto: <strong>@presupuesto.NombreCliente</strong></span>
                                </div>
                            </div>
                        </td>
                    </tr>

                    @foreach (var item in presupuesto.Cotizaciones)
                    {
                        decimal precioAMostrar = (rol == "Distribuidor") ? (item.PrecioCortinaDistribuidor + item.PrecioCortineroDistribuidor) : item.TotalPublico;
                        <tr class="fila-cotizacion">
                            <td><strong>@item.Area</strong><br><small>@item.Sistema</small></td>
                            <td>@item.Marca - @item.Modelo<br><small>Color: @item.ColorSeleccionado</small></td>
                            <td>@item.Ancho.ToString("N2") x @item.Alto.ToString("N2") m</td>
                            <td class="col-precio"><span class="price-total">@precioAMostrar.ToString("C")</span></td>
                            <td class="col-acciones">
                                <div class="action-menu">
                                    <button class="btn-toggle" onclick="toggleMenu(event, this)">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-content">
                                        <a href="@Url.Action("Editar", "Clientes", new { id = item.Id })" class="dropdown-item">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function toggleMenu(event, btn) {
        event.stopPropagation();
        const content = btn.nextElementSibling;
        document.querySelectorAll('.dropdown-content').forEach(d => {
            if (d !== content) d.classList.remove('show');
        });
        content.classList.toggle('show');
    }

    window.onclick = function(event) {
        if (!event.target.matches('.btn-toggle') && !event.target.matches('.fa-ellipsis-v')) {
            document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
        }
    }

    function filtrarTabla() {
        const query = document.getElementById('txtBuscar').value.toLowerCase().trim();
        document.querySelectorAll('.group-header').forEach(header => {
            const info = header.getAttribute('data-searchable').toLowerCase();
            let visible = info.includes(query);
            let fila = header.nextElementSibling;
            while (fila && fila.classList.contains('fila-cotizacion')) {
                const text = fila.innerText.toLowerCase();
                const filaVisible = text.includes(query) || info.includes(query);
                fila.style.display = filaVisible ? "" : "none";
                if (filaVisible) visible = true;
                fila = fila.nextElementSibling;
            }
            header.style.display = visible ? "" : "none";
        });
    }
</script>